<div [classList]="'col-12 card transition-all transition-duration-100 urgency-' + task.urgency"
    (click)="showAddTaskModal = true" pDraggable (onDragStart)="cardDragStart()" (onDragEnd)="cardDragEnd()">
    <div class="urgency"></div>


    <!-- HEADER -->
    <header>
        <div class="content-container">
            <span class="font-medium title">{{ task.title }}</span>
            <div class="date-container">
                <span class="date text-xs font-medium">{{ task.creationDate | date: 'd/MM, yyyy' }}</span>
                |
                <span class="time-container">
                    <span class="material-symbols-rounded time-icon">timer</span>
                    <span class="time text-xs font-medium">{{ task.creationDate | date: 'HH:mm' }}</span>
                </span>
            </div>
        </div>
        <div class="flex align-items-center gap-2 md:gap-4" style="position: relative; top: 2.5px">
            <button class="btn btn-icon text" (click)="toggleTaskCompleted($event, task)">
                <span class="material-icons"
                    [classList]="task.completed ? 'material-icons text-green-500' : 'material-icons'">
                    check_circle
                </span>
            </button>
            <button class="btn btn-icon text" (click)="deleteTask($event)">
                <span class="material-icons text-red-500">delete</span>
            </button>
        </div>
    </header>
    <!-- /HEADER -->


    <!-- BODY -->
    <div class="body">
        <!-- LABELS -->
        <div class="label-container">
            <div class="label font-medium" *ngFor="let label of task.labels" [style.color]="label.color"
                [style.background]="label.background">
                {{ label.name }}
            </div>
        </div>
        <!-- /LABELS -->

        <!-- DESCRIPTION -->
        <span class="description font-regular">{{ task.description }}</span>
        <!-- /DESCRIPTION -->
    </div>


    <!-- CHECKBOXES -->
    <div class="footer">
        <button class="btn btn-icon text flex aling-items-center gap-2" (click)="showCheckbox($event, task.id)">
            <span
                [classList]="!showCheckboxes ? 'text-700 text-sm font-regular' : 'text-blue-500 text-sm font-regular'">{{
                task.checkboxes.length }}</span>
            <span
                [classList]="!showCheckboxes ? 'material-symbols-rounded text-700 text-sm' : 'material-symbols-rounded text-blue-500 text-sm'">checklist</span>
        </button>
        <button class="btn btn-icon text flex aling-items-center gap-2" (click)="showImagesFooter($event, task.id)"
            *ngIf="task.images">
            <span [classList]="!showImages ? 'text-700 text-sm font-regular' : 'text-blue-500 text-sm font-regular'">{{
                task.images.length }}</span>
            <span
                [classList]="!showImages ? 'material-symbols-rounded text-700 text-sm' : 'material-symbols-rounded text-blue-500 text-sm'">attach_file</span>
        </button>
    </div>

    <div class="checkbox-footer w-full transition-all transition-duration-150 fadein" *ngIf="showCheckboxes">
        <div class="flex checkbox w-full flex-row align-items-center gap-2"
            *ngFor="let checkbox of task.checkboxes; let i = index">
            <label [classList]="checkbox.checked ? 'checkbox-container is-checked' : 'checkbox-container'"
                (click)="saveCheckbox($event)">
                <input type="checkbox" [(ngModel)]="checkbox.checked">
                <span class="checkbox-helper"></span>
                <span class="outline">
                    <span class="outline-tick"></span>
                </span>
            </label>
            <input class="checkbox-input" type="text" placeholder="Enter text..."
                (click)="saveCheckbox($event, true, checkbox)" (click)="manageInlineCheckboxEdit($event)"
                [(ngModel)]="checkbox.title" />
            <button class="btn btn-icon text p-3" (click)="deleteCheckbox($event, checkbox)">
                <span class="material-icons text-red-500">delete</span>
            </button>
        </div>
        <button class="btn btn-text font-regular ml-2" (click)="addCheckbox($event)">
            <span class="material-icons text-500">add</span>
            Add Subtask
        </button>
    </div>
    <!-- /CHECKBOXES -->
</div>

<!-- EDIT TASK MODAL -->
<div class="dialog-container" *ngIf="showAddTaskModal">
    <div class="dialog">
        <div class="dialog-header">
            <div class="flex flex-row align-items-center gap-3 w-full">
                <span class="dialog-title font-regular text-lg">
                    Dashboard /
                    {{project.title}} /
                    Edit Task</span>
            </div>
            <div class="flex align-items-center gap-4">
                <button class="btn btn-icon text" (click)="hideModal()">
                    <span class="material-icons text-2xl">
                        minimize
                    </span>
                </button>
            </div>
        </div>
        <div class="dialog-content max-h-full md:max-h-30rem">
            <div class="flex flex-row align-items-baseline gap-2">
                <button *ngIf="task.id !== ''" class="btn btn-icon text" (click)="toggleTaskCompleted()">
                    <span
                        [classList]="task.completed ? 'material-icons text-green-500 text-2xl' : 'material-icons text-2xl'">
                        check_circle
                    </span>
                </button>
                <div class="flex flex-column gap-2 p-3 w-full" style="border: 1px solid #E1E3E8; border-radius: 8px;">
                    <input type="text" class="border-0 font-bold text-lg outline-0 p-0" id="title"
                        placeholder="Enter a title..." [(ngModel)]="task.title">
                    <textarea id="description" class="border-0 mt-1 outline-0 p-0" rows="3"
                        placeholder="Enter a description..." [(ngModel)]="task.description"></textarea>
                </div>
            </div>

            <div class="flex flex-column gap-2 mt-5 mb-4">
                <div class="flex align-items-center gap-3 p-2 cursor-pointer"
                    (click)="showModalCheckboxes = !showModalCheckboxes" style="border-bottom: 1px solid #E1E3E8">
                    <span class="material-icons text-500" *ngIf="showModalCheckboxes">keyboard_arrow_down</span>
                    <span class="material-icons text-500" *ngIf="!showModalCheckboxes">keyboard_arrow_up</span>
                    <span class="font-bold">Subtasks</span>
                    <span class="text-500 text-sm">{{getTotalCompletedTasks()}} / {{task.checkboxes.length}}</span>
                </div>
                <div class="flex flex-column gap-2 mt-2" *ngIf="task.checkboxes && showModalCheckboxes">
                    <div class="flex checkbox flex-row align-items-center gap-2"
                        *ngFor="let checkbox of task.checkboxes">
                        <label [classList]="checkbox.checked ? 'checkbox-container is-checked' : 'checkbox-container'">
                            <input type="checkbox" [(ngModel)]="checkbox.checked">
                            <span class="checkbox-helper"></span>
                            <span class="outline">
                                <span class="outline-tick"></span>
                            </span>
                        </label>
                        <input class="checkbox-input" placeholder="Enter subtask..." type="text"
                            [(ngModel)]="checkbox.title">
                        <button class="btn btn-icon text" (click)="deleteCheckbox($event, checkbox)">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                    <button class="btn btn-text font-regular ml-2" (click)="addCheckbox()">
                        <span class="material-icons text-500">add</span>
                        Add Subtask
                    </button>
                </div>
            </div>

            <div class="flex align-items-center gap-3 p-2 cursor-pointer" (click)="showModalFiles = !showModalFiles"
                style="border-bottom: 1px solid #E1E3E8">
                <span class="material-icons text-500" *ngIf="showModalFiles">keyboard_arrow_down</span>
                <span class="material-icons text-500" *ngIf="!showModalFiles">keyboard_arrow_up</span>
                <span class="font-bold">Attatchments</span>
            </div>
            <div class="flex flex-column pt-2 gap-3" *ngIf="showModalFiles">
                <div class="flex align-items-center flex-wrap gap-3">
                    <div class="relative" *ngFor="let image of task.images">
                        <div class="attatchment-button cursor-pointerr" (click)="selectedImage = image.url">
                            <span class="material-symbols-rounded border-400 border-radius-lg p-3">
                                file_open
                            </span>
                            {{image.name}}
                        </div>
                        <button class="btn btn-icon text absolute" style="top:6px; right:8px"
                            (click)="removeImage(image)">
                            <span class="material-icons text-red-500">delete</span>
                        </button>
                    </div>
                </div>
                <input class="custom-file btn btn-text p-0 w-1" style="height: 24px;" type="file" id="images" (change)="uploadTaskImage($event)">
            </div>

            <div class="flex flex-column md:flex-row aling-items-center justify-content-between gap-3 mt-2">
                <div class="flex flex-column gap-2 w-full md:w-6">
                    <label for="labels">Labels</label>
                    <p-multiSelect [options]="labelsList" [classList]="'w-full'" [ngStyle]="{width: '100%'}"
                        defaultLabel="Select Labels..." [(ngModel)]="task.labels" optionLabel="name"
                        display="chip"></p-multiSelect>
                </div>
                <div class="flex flex-column gap-2 w-full md:w-6">
                    <label for="urgency">Urgency</label>
                    <p-dropdown [options]="urgencyList" [classList]="'w-full'" [ngStyle]="{width: '100%'}"
                        placeholder="Select Urgency..." appendTo="body" [showClear]="true" [(ngModel)]="task.urgency"
                        optionLabel="title" optionValue="code"></p-dropdown>
                </div>
            </div>
        </div>
        <div class="dialog-footer absolute md:relative bottom-0 w-full">
            <button type="button" class="btn btn-secondary" (click)="hideModal()">
                <span class="material-icons">close</span>
                Cancel
            </button>
            <button type="button" class="btn btn-primary" (click)="editTask()">
                <span class="material-symbols-rounded">save</span>
                Save
            </button>
        </div>
    </div>
</div>

<div class="dialog-container" *ngIf="selectedImage !== ''">
    <button class="btn btn-icon absolute" style="top: 138px; right: 22%" (click)="selectedImage = ''">
        <span class="material-icons">
            close
        </span>
    </button>
    <div class="dialog">
        <img [src]="selectedImage" class="w-full h-full shadow-1 pointer-events-none">
    </div>
</div>
